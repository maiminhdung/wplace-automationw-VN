<!DOCTYPE html>
<html lang="vi-VN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình chuyển đổi ảnh cho WPlace Bot</title>
    <style>
        /* CSS không thay đổi */
    </style>
</head>
<body>
    <div class="container">
        <h1>🎨 Trình chuyển đổi ảnh cho WPlace Bot</h1>
        
        <div class="upload-section" id="uploadSection">
            <div>
                <h3>📁 Chọn hoặc kéo thả một ảnh</h3>
                <p>Định dạng được hỗ trợ: PNG, JPG, JPEG, GIF</p>
                <input type="file" id="fileInput" accept="image/*">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    Chọn Tệp
                </button>
            </div>
        </div>
        
        <div class="settings">
            <div class="setting-group">
                <label for="maxWidth">Chiều rộng Tối đa (px):</label>
                <input type="number" id="maxWidth" value="50" min="1" max="200">
            </div>
            
            <div class="setting-group">
                <label for="maxHeight">Chiều cao Tối đa (px):</label>
                <input type="number" id="maxHeight" value="50" min="1" max="200">
            </div>
            
            <div class="setting-group">
                <label for="colorMode">Chế độ Màu:</label>
                <select id="colorMode">
                    <option value="palette">Bảng màu Giới hạn</option>
                    <option value="full">Màu đầy đủ</option>
                    <option value="grayscale">Thang độ xám</option>
                </select>
            </div>
            
            <div class="setting-group">
                <label for="startX">Vị trí X Ban đầu:</label>
                <input type="number" id="startX" value="100" min="0">
            </div>
            
            <div class="setting-group">
                <label for="startY">Vị trí Y Ban đầu:</label>
                <input type="number" id="startY" value="100" min="0">
            </div>
            
            <div class="setting-group">
                <label for="delay">Delay giữa các pixel (ms):</label>
                <input type="number" id="delay" value="1000" min="100" max="10000">
            </div>
        </div>
        
        <div class="preview-section" id="previewSection">
            <div class="preview-container">
                <div class="original-preview">
                    <h3>📷 Ảnh Gốc</h3>
                    <canvas id="originalCanvas"></canvas>
                </div>
                
                <div class="converted-preview">
                    <h3>🎯 Phiên bản đã Chuyển đổi</h3>
                    <canvas id="convertedCanvas"></canvas>
                </div>
            </div>
        </div>
        
        <div class="actions">
            <button class="btn" id="convertBtn" onclick="convertImage()">🔄 Chuyển đổi Ảnh</button>
            <button class="btn generate" id="generateBtn" onclick="generateScript()" disabled>📝 Tạo Script</button>
        </div>
        
        <div class="output-section" id="outputSection">
            <div class="output-tabs">
                <button class="tab active" onclick="showTab('script')">📜 Script Đầy đủ</button>
                <button class="tab" onclick="showTab('function')">🔧 Hàm Tùy chỉnh</button>
                <button class="tab" onclick="showTab('data')">📊 Dữ liệu Ảnh</button>
            </div>
            
            <div class="output-content">
                <div id="scriptTab" class="tab-content">
                    <div class="stats" id="imageStats"></div>
                    <div class="warning" id="warning" style="display: none;"></div>
                    <div class="code-output" id="scriptOutput"></div>
                    <button class="copy-btn" onclick="copyToClipboard('scriptOutput')">📋 Sao chép Script</button>
                </div>
                
                <div id="functionTab" class="tab-content" style="display: none;">
                    <div class="code-output" id="functionOutput"></div>
                    <button class="copy-btn" onclick="copyToClipboard('functionOutput')">📋 Sao chép Hàm</button>
                </div>
                
                <div id="dataTab" class="tab-content" style="display: none;">
                    <div class="code-output" id="dataOutput"></div>
                    <button class="copy-btn" onclick="copyToClipboard('dataOutput')">📋 Sao chép Dữ liệu</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let originalImage = null;
        let convertedPixels = [];
        let imageWidth = 0;
        let imageHeight = 0;

        // Bảng màu giới hạn cho chế độ palette
        const limitedPalette = [
            '#FFFFFF', '#E4E4E4', '#888888', '#222222', '#FFA7D1', '#E50000', '#E59500',
            '#A06A42', '#E5D900', '#94E044', '#02BE01', '#00D3DD', '#0083C7', '#0000EA',
            '#CF6EE4', '#820080', '#000000', '#FF0000', '#00FF00', '#0000FF', '#FFFF00',
            '#FF00FF', '#00FFFF', '#FFA500', '#800080', '#008000', '#000080', '#808080'
        ];

        // Cấu hình kéo và thả
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');

        // ... (JS logic không thay đổi)

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Vui lòng chọn một tệp ảnh hợp lệ.');
                return;
            }
            // ...
        }
        
        // ... (JS logic không thay đổi, chỉ dịch các chuỗi hiển thị cho người dùng)

        function generateScriptOutput(startX, startY, delay) {
            const imageName = 'imported_image';
            
            const script = `// Script được tạo tự động cho WPlace Bot
// Ảnh: ${imageWidth}x${imageHeight} pixel (${convertedPixels.length} pixel để vẽ)
// Vị trí ban đầu: (${startX}, ${startY})
// Delay: ${delay}ms

// Dữ liệu ảnh
const ${imageName}Data = [
${convertedPixels.map(p => `    { x: ${p.x}, y: ${p.y}, color: '${p.color}' }`).join(',\n')}
];

// Hàm để tải ảnh vào bot
function load${imageName.charAt(0).toUpperCase() + imageName.slice(1)}() {
    if (typeof wplaceBot === 'undefined') {
        console.error('❌ Không tìm thấy WPlace Bot! Hãy chắc chắn rằng bạn đã tải bot trước.');
        return;
    }
    
    wplaceBot.pixels = ${imageName}Data.slice(); // Sao chép dữ liệu
    wplaceBot.setStartPosition(${startX}, ${startY});
    wplaceBot.setDelay(${delay});
    
    console.log('✅ Đã tải ảnh: ${imageWidth}x${imageHeight} pixel');
    console.log('📍 Vị trí ban đầu: (${startX}, ${startY})');
    console.log('⏱️ Delay: ${delay}ms');
    console.log('🎨 Tổng số pixel: ${convertedPixels.length}');
    console.log('');
    console.log('Để bắt đầu vẽ, sử dụng: wplaceBot.start()');
}

// Tải ảnh tự động
load${imageName.charAt(0).toUpperCase() + imageName.slice(1)}();

// Hướng dẫn:
// 1. Dán script này vào console của trình duyệt tại trang wplace.live
// 2. Đảm bảo rằng WPlace Bot đã được tải
// 3. Chạy wplaceBot.start() để bắt đầu vẽ`;

            document.getElementById('scriptOutput').textContent = script;
        }

        function generateFunctionOutput() {
            const functionCode = `// Hàm tùy chỉnh để tải ảnh của bạn
function loadCustomImage() {
    const imageData = [
${convertedPixels.map(p => `        { x: ${p.x}, y: ${p.y}, color: '${p.color}' }`).join(',\n')}
    ];
    
    if (typeof wplaceBot !== 'undefined') {
        wplaceBot.pixels = imageData.slice();
        console.log('✅ Đã tải ảnh tùy chỉnh: ${imageWidth}x${imageHeight} pixel (${convertedPixels.length} pixel)');
    } else {
        console.error('❌ Không tìm thấy WPlace Bot!');
    }
}

// Để sử dụng hàm này:
// loadCustomImage();
// wplaceBot.setStartPosition(x, y); // Đặt vị trí
// wplaceBot.start(); // Bắt đầu vẽ`;

            document.getElementById('functionOutput').textContent = functionCode;
        }

        function generateDataOutput() {
            const dataCode = `// Dữ liệu thô của ảnh (${imageWidth}x${imageHeight} pixel)
const imagePixels = [
${convertedPixels.map(p => `    { x: ${p.x}, y: ${p.y}, color: '${p.color}' }`).join(',\n')}
];

// Thông tin ảnh:
// Chiều rộng: ${imageWidth} pixel
// Chiều cao: ${imageHeight} pixel
// Tổng số pixel: ${convertedPixels.length}
// Số màu duy nhất: ${[...new Set(convertedPixels.map(p => p.color))].length}`;

            document.getElementById('dataOutput').textContent = dataCode;
        }

        function updateStats() {
            const uniqueColors = [...new Set(convertedPixels.map(p => p.color))];
            const estimatedTime = Math.ceil((convertedPixels.length * parseInt(document.getElementById('delay').value)) / 1000 / 60);
            
            const statsHTML = `
                <strong>📊 Thống kê Ảnh:</strong><br>
                • Kích thước: ${imageWidth} x ${imageHeight} pixel<br>
                • Pixel cần vẽ: ${convertedPixels.length}<br>
                • Số màu duy nhất: ${uniqueColors.length}<br>
                • Thời gian ước tính: ~${estimatedTime} phút
            `;
            
            document.getElementById('imageStats').innerHTML = statsHTML;
            
            // Hiển thị cảnh báo nếu ảnh quá lớn
            const warning = document.getElementById('warning');
            if (convertedPixels.length > 1000) {
                warning.style.display = 'block';
                warning.innerHTML = `
                    <strong>⚠️ Cảnh báo:</strong> Ảnh này có ${convertedPixels.length} pixel, có thể mất nhiều thời gian để vẽ 
                    (khoảng ${estimatedTime} phút). Hãy cân nhắc giảm kích thước tối đa của ảnh hoặc tăng delay giữa các pixel.
                `;
            } else {
                warning.style.display = 'none';
            }
        }
        
        function copyToClipboard(elementId) {
            // ...
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ Đã sao chép!';
                // ...
            }).catch(err => {
                console.error('Lỗi khi sao chép:', err);
                alert('Lỗi khi sao chép vào clipboard');
            });
        }
    </script>
</body>
</html>